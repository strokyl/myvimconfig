/**
 * 
 */
var EditActuCtrl = function ($scope, $routeParams, $translate, $location, $window, BrancheService, ActuService, ImageService, ActuForm) {

	this.scope = $scope;

    //usefull for the form directive because of the gallery that upload image to the 
    //branche folder
	$scope.brancheName = $routeParams.brancheName;

    //usefull for the form directive because of the gallery that upload image to the 
    //branche folder
	$scope.images = ImageService.getAll({brancheName:$routeParams.brancheName});

	var themes = [];

	$scope.startWait();
	var themesPromise =  BrancheService.themes({brancheName:$routeParams.brancheName});
	
	themesPromise.$then(function (data) {

        for (var i = 0; i < data.data.length; i++) {
            themes.push(data.data[i]);
        };

		if(!$scope.actu.actuTheme) {
			$scope.actu.actuTheme = data.data[0];
		}

		$scope.endWait();

	});

	$scope.startWait();
	var unitSitesPromise =  BrancheService.unitsites({brancheName:$routeParams.brancheName});
	
    var unitSites = [];
	unitSitesPromise.$then(function (data) {
        for (var i = 0; i < data.data.length; i++) {
            unitSites.push(data.data[i]);
        };
		if(!$scope.actu.unitSite) {
			$scope.actu.unitSite = data.data[0];
		}

		$scope.endWait();
	});
	

	
	this.scope.saveChange = angular.bind(this, this.saveChange, ActuService, $translate, $location);
	this.scope.publish = angular.bind(this, this.publish, ActuService, $translate, $location);
	this.scope.apercu = angular.bind(this, this.apercu, ActuService, $translate, $location, $window);
	this.scope.cancel = angular.bind(this, this.cancel, $location);
	
    if($scope.actu["@type"]) {
        $scope.form = ActuForm.getForm(data.data["@type"], $scope.createActu, themes, unitSites  );
    } else {
        this.scope.actu.$then(function(data) {
            $scope.form = ActuForm.getForm(data.data["@type"], $scope.createActu, themes, unitSites  );
        });
    }

};


EditActuCtrl.prototype.goBackToList = function($location) {
	$location.path("/site/"+this.scope.brancheName);
};

EditActuCtrl.prototype.saveChange = function (ActuService, $translate, $location) {
		var scope = this.scope;
		scope.startWait();
		var that = this;

		ActuService.put({brancheName:this.scope.brancheName}, this.scope.actu).$then(function() {
			scope.flashMessage($translate("actu.updated", {'actuFile': scope.actu.actuFile, 'brancheName' :scope.brancheName}));
			scope.endWait();
			that.goBackToList($location);
			scope.changeToSave = false;
			scope.actu.draft = true;
		}, function(error) {
			scope.endWait();
			scope.onError(resp,this.scope.columns);
		});

	};

EditActuCtrl.prototype.apercu = function (ActuService, $translate, $location, $window) {
		var scope = this.scope;
		scope.startWait();
		var actuFile = scope.actuFile || scope.actu.actuFile;
		console.log("article", actuFile);
		ActuService.put({brancheName:scope.brancheName}, scope.actu).$then(function() {
			scope.flashMessage($translate("actu.updated", {'actuFile': actuFile, 'brancheName' :scope.brancheName}));
            scope.changeToSave = false;
            ActuService.getOverview({brancheName:scope.brancheName, actuFile:actuFile}, function(data) {
                var url = data.url;
                scope.endWait();
                $window.open(url);
            }, function(error) {
                console.log(error)
                scope.endWait();
            scope.onError(error);
            });
		}, function(error) {
			scope.endWait();
			scope.onError(resp,this.scope.columns);
		});

	};

EditActuCtrl.prototype.publish = function (ActuService, $translate, $location) {
		var scope = this.scope;
		scope.startWait();
		var that = this;
		var actuFile = scope.actuFile || scope.actu.actuFile;
		ActuService.put({brancheName:scope.brancheName}, scope.actu).$then(function() {
			scope.flashMessage($translate("actu.updated", {'actuFile': actuFile, 'brancheName' :scope.brancheName}));
			scope.changeToSave = false;
		   ActuService.publish({brancheName:scope.brancheName, actuFile:actuFile}, null, function(data) {
			   scope.flashMessage($translate("actu.publish", {'actuFile': actuFile, 'brancheName' :scope.brancheName}));
			   var url = data.url;
			   scope.endWait();
			   scope.actu.draft = false;
			   that.goBackToList($location);
		   }, function(error) {
			   console.log(error)
			   scope.endWait();
			   scope.onError(error);
		   });
		}, function(error) {
			scope.endWait();
			scope.onError(resp,this.scope.columns);
		});

	};

//reviens à la liste des actualités
EditActuCtrl.prototype.cancel = function ($location) {
	this.goBackToList($location);
};
