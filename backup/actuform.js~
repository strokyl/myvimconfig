'use strict';

angular.module('Ngwis.Services').
factory('ActuForm', ['FileService', function (FileService) {

    var lang = [{id:'fr', lang:'generic.french'}, {id:'en', lang: 'generic.english'}];

	var capitalize = function(s) {
	    return s[0].toUpperCase() + s.slice(1);
	};

    var buildLangId = function(fieldName) {
        var j, l;
        var field = [];
        for (j = 0; j < lang.length; j++) {
            l = lang[j].id;
            field.push({
                lang:l,
                id:fieldName+capitalize(l)
            });
        }
        return field;
    };

    var titre = { id : buildLangId('titre'), label : "actu.title", type: "text" };

    var actuDate = { id : "actuDate", label : "generic.date", type : "date" };

    var theme = function(id, label, choices) {
        return{ id: id, label: label, type : "liste", choices : choices}; 
    };

    var unitSite = function(id, choices) {
        return { id: id, label: "actu.unitSite", type : "liste" , choices : choices};
    };

    var texteRiche = { id : buildLangId("texteRiche"), label : "actu.body", type : "html" }; 

    var advanced = { id : "advanced", label : "actu.advancedMode", type : "checkbox" };

    var chapeau  = { id : buildLangId("chapeau"), label : "actu.hat",
        type : "textarea"
    };

    var chapeauMiddlepack = angular.copy(chapeau);
    chapeauMiddlepack.displayIf = "advanced";

    var une = { id : "une", label:  "actu.one", type : "checkbox", displayIf : "advanced" };

    var hot = { id : "hot", label : "actu.hot", type : "checkbox", displayIf : "advanced" };

    var actuFile = { id : "actuFile", label : "actu.fileName", type : "text" };

    var lecteur = function(choices) {
        return { id : "lecteur", label : "actu.reader", type : "liste", choices : choices };
    };

    var mail = function(choices) {
        return { id : "mail", label : "actu.sendMail", type : "liste", choices : choices };
    };



    return {
        getForm : function(newActu, branche) {
            var form; 

            var brancheName = branche.brancheName;

            var type = branche["@type"];

            var _unitSite = unitSite(branche.unitSites);


            var images = FileService.getImages({brancheName:branche.brancheName});

            var image = {
                id : buildLangId("image"),
                brancheName : brancheName,
                label : "actu.picture",
                type : "gallery",
                files : images,
                filetype : "image"
            };

            if(type === "middlePack") {

                image.imageWidth = 220;

                form = {
                    lang : lang,
                    fields : [
                        titre,
                        actuDate,
                        theme("actuTheme", "actu.theme", branche.themes),
                        _unitSite,
                        texteRiche,
                        image,
                        advanced,
                        chapeauMiddlepack,
                        une,
                        hot
                    ]
                };

            } else if (type === "ITComm") {

                var _mail  = mail(branche.mails);

                var _lecteur = lecteur(branche.lecteurs);

                image.imageWidth = 480;

                var videos = FileService.getVideos({brancheName:branche.brancheName});
                var video = {
                    id : buildLangId("video"),
                    brancheName : brancheName,
                    label : "actu.video",
                    type : "gallery",
                    files : videos,
                    filetype : "video"
                };

                var imageSlider = {
                    id : buildLangId("imageSlider"),
                    brancheName : brancheName,
                    label : "actu.sliderPicture",
                    type : "gallery",
                    files : images,
                    filetype : "image",
                    imageWidth : 230,
                };

                var imagePortail = {
                    id : buildLangId("imagePortail"),
                    brancheName : brancheName,
                    label : "actu.portailPicture",
                    type : "gallery",
                    files : images,
                    imageWidth : 230,
                    filetype : "image"
                };

                form = {
                    lang : lang,
                    fields : [
                        titre,
                        actuDate,
                        theme("theme1", "actu.theme1", branche.themes),
                        theme("theme2", "actu.theme2", branche.themes),
                        theme("theme3", "actu.theme3", branche.themes),
                        _unitSite,
                        chapeau,
                        texteRiche,
                        video,
                        image,
                        imageSlider,
                        imagePortail,
                        _lecteur,
                        _mail
                    ]
                };

            }

            if(newActu) {
                form.fields.unshift(actuFile);
            };

            return form;
        }
    };

}]);

