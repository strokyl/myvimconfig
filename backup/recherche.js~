$(document).ready(function() {
    var SEARCH_API_URL = '/rest/search/';
    var ID_RESULT_BLOCK = '#containerpagelistsearch';

    var getUrlVars = function () {
        var vars = [], hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for(var i = 0; i < hashes.length; i++)
        {
            hash = hashes[i].split('=');
            vars.push(hash[0]);
            vars[hash[0]] = hash[1];
        }
        return vars;
    }

    var formatDate = function() {
        return function(content, render) {
            var dateEpoch = parseInt(render(content), 10);
            var date = new Date(dateEpoch);
            return date.getDay() + "/" + date.getMonth() + "/" + date.getFullYear();
        };
    };

    var template = null;

    var renderResult = function(result) {

        if(template === null) {
            $.get('/technical/html/searchResult.html',function(_template) {
                template = _template;
                Mustache.parse(template);
                renderResult(result);
            });
            return;
        }

        result.formatDate = formatDate;

        var html = Mustache.render(template, result);
        $(ID_RESULT_BLOCK).html(html);

        setTimeout(Favori.setFavori);
    };


    var query = decodeURIComponent(getUrlVars()["query"]);
    console.log("query", query);

    if(query) {
        $.ajax(SEARCH_API_URL + encodeURI(query), {
            type: 'GET',
            crossDomain: true,
            success: function(result) {
                console.log("result", result);
                renderResult(result);
            },
            error: function() {
                console.error("Error when calling the search API")
            }
        });

    }

});
