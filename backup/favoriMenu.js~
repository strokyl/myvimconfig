$(document).ready(function () {

    var callback = (function () {
        var i = 2;
        return function() {
            if(!--i) {
                Favori.setFavori();
            }
        };
    })();

    //renderTemplate is a function that take four arugument
    //idArticle and liste
    //idArticle is the id where the html will be inserted
    //templateUrl 
    //list is the list of news
    //callback is a function call when everything is done with the templateUrl
    var renderTemplate = (function () {
        var template = {};

        var render = function (idArticle, templateUrl, liste, callback) {
            $(idArticle).html(Mustache.render(template[templateUrl], {news:liste}));
            callback(templateUrl);
        };


        return function(idArticle, templateUrl, liste, callback) {
            if(template[templateUrl]) {
                render(idArticle, templateUrl, liste, callback);
            } else {
                $.get(templateUrl, function(_template) {
                    template[templateUrl] = _template;
                    Mustache.parse(_template);
                    render(idArticle, templateUrl, liste, callback);
                })};
        }
    }

    )();

    var displayArticle = function(favoris) {
        var urls = [];
        for (var i = 0; i < favoris.length; i++) {
            urls.push(favoris[i].url);
        };

        var liste = [];

        var themes = ["theme1", "theme2", "theme3", "theme4"];
        var t;

        for (var i = 0; i < itemsNews.length; i++) {
            var item = itemsNews[i];

            for (var j = 0; j < themes.length; j++) {
                t = themes[j];
                if(item[t] === "null") {
                    item[t] = null;
                }
            };

            if($.inArray(item.url, urls) !== -1) {
                liste.push(item);
            }

        };

        renderTemplate("#liste-actus", '/technical/html/listeNewsTemplate.html', liste, callback);
    };

    var displayDocument = function(favoris) {
        var documents = [];

        for (var i = 0; i < favoris.length; i++) {
            doc = favoris[i];
            if(doc.section) {
                documents.push(doc);
            }
        };

        renderTemplate("#demultiplier", '/technical/html/listeDocumentTemplate.html', documents, callback);
    };



    Favori.getAll(function(favoris) {
        displayArticle(favoris);
        displayDocument(favoris);
    });
});
